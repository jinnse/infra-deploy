version: '3.8'

services:
#etcdëŠ” Patroni í´ëŸ¬ìŠ¤í„°ì˜ ìƒíƒœë¥¼ ê³µìœ í•˜ê³  ë¦¬ë” ì„ ì¶œì„ ë‹´ë‹¹í•˜ëŠ” ë¶„ì‚° í‚¤-ê°’ ì €ì¥ì†Œì…ë‹ˆë‹¤.
  etcd:
    image: quay.io/coreos/etcd:v3.5.0networkss
    container_name: etcd
    environment:
      - ALLOW_NONE_AUTHENTICATION=true # ì¸ì¦ ì—†ì´ ì‹¤í–‰ (í•™ìŠµ/ê°œë°œìš©)
      - ETCD_NAME=etcd # etcd ë…¸ë“œ ì´ë¦„
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd:2380 # ì´ˆê¸° í”¼ì–´ URL í´ëŸ¬ìŠ¤í„° ê°„ í†µì‹ ìš©
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379 # í´ë¼ì´ì–¸íŠ¸ í†µì‹ ìš©
      - ETCD_LISTEN_PEER_URLS=http://etcd:2380 # í”¼ì–´ í†µì‹ ìš©
      - ETCD_LISTEN_CLIENT_URLS=http://etcd:2379 # í´ë¼ì´ì–¸íŠ¸ í†µì‹ ìš©
    ports:
      - "2379:2379" # í´ë¼ì´ì–¸íŠ¸ í†µì‹ ìš© í¬íŠ¸
      - "2380:2380" # í´ëŸ¬ìŠ¤í„° í†µì‹ ìš© í¬íŠ¸
    networks:
      - patroni-net # Docker ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°

# ğŸ“Œ db1ì€ Patroniê°€ ë¶™ì€ PostgreSQL Primary í›„ë³´ ë…¸ë“œì…ë‹ˆë‹¤.
  db1:
    image: registry.opensource.zalan.do/acid/patroni:2.1-p1
    container_name: db1
    volumes:
    # - /mnt/shared/db1:/home/postgres/pgdata # ë°ì´í„° ë””ë ‰í† ë¦¬
      - /home/postgres/pgdata:/home/postgres/pgdata # ë°ì´í„° ë””ë ‰í† ë¦¬
      - ./patroni/db1.yml:/config/patroni.yml # Patroni ì„¤ì • íŒŒì¼
    environment:
      - PATRONI_CONFIG_FILE=/config/patroni.yml #Patroni ì„¤ì • ê²½ë¡œ ì§€ì •
    ports:
      - "5432:5432" # PostgreSQL í¬íŠ¸
    depends_on:
      - etcd # etcd ì„œë¹„ìŠ¤ì— ì˜ì¡´
    networks:
      - patroni-net # Docker ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°

# ğŸ“Œ db2ëŠ” Patroniê°€ ë¶™ì€ PostgreSQL Replicaì…ë‹ˆë‹¤.
  db2:
    image: registry.opensource.zalan.do/acid/patroni:2.1-p1
    container_name: db2
    volumes:
    # - /mnt/shared/db2:/home/postgres/pgdata                  # db2ì˜ ë³„ë„ ë°ì´í„° ë³¼ë¥¨
      - /home/postgres/pgdata:/home/postgres/pgdata # ë°ì´í„° ë””ë ‰í† ë¦¬ 
      - ./patroni/db2.yml:/config/patroni.yml
    environment:
      - PATRONI_CONFIG_FILE=/config/patroni.yml
    ports:
      - "5433:5432"                                             # ë‹¤ë¥¸ í¬íŠ¸ë¡œ ì—´ì–´ ì¶©ëŒ ë°©ì§€
    depends_on:
      - etcd
    networks:
      - patroni-net

 # ğŸ§­ HAProxyëŠ” í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì„ í˜„ì¬ Primary PostgreSQL ë…¸ë“œë¡œ ìë™ ë¼ìš°íŒ…í•©ë‹ˆë‹¤.
  haproxy:
    image: haproxy:2.4
    container_name: haproxy
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "5000:5000"      # í´ë¼ì´ì–¸íŠ¸ëŠ” í•­ìƒ ì´ í¬íŠ¸ë¡œ ì ‘ì†
    depends_on:
      - db1
      - db2
    networks:
      - patroni-net

networks:
  patroni-net:
    driver: bridge # Docker ë¸Œë¦¬ì§€ ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©