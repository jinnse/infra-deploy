version: '3.8'

services:
#etcdλ” Patroni ν΄λ¬μ¤ν„°μ μƒνƒλ¥Ό κ³µμ ν•κ³  λ¦¬λ” μ„ μ¶μ„ λ‹΄λ‹Ήν•λ” λ¶„μ‚° ν‚¤-κ°’ μ €μ¥μ†μ…λ‹λ‹¤.
  etcd:
    image: quay.io/coreos/etcd:v3.5.0
    container_name: etcd
    environment:
      - ALLOW_NONE_AUTHENTICATION=true # μΈμ¦ μ—†μ΄ μ‹¤ν–‰ (ν•™μµ/κ°λ°μ©)
      - ETCD_NAME=etcd # etcd λ…Έλ“ μ΄λ¦„
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd:2380 # μ΄κΈ° ν”Όμ–΄ URL ν΄λ¬μ¤ν„° κ°„ ν†µμ‹ μ©
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379 # ν΄λΌμ΄μ–ΈνΈ ν†µμ‹ μ©
      - ETCD_LISTEN_PEER_URLS=http://etcd:2380 # ν”Όμ–΄ ν†µμ‹ μ©
      - ETCD_LISTEN_CLIENT_URLS=http://etcd:2379 # ν΄λΌμ΄μ–ΈνΈ ν†µμ‹ μ©
    ports:
      - "2379:2379" # ν΄λΌμ΄μ–ΈνΈ ν†µμ‹ μ© ν¬νΈ
      - "2380:2380" # ν΄λ¬μ¤ν„° ν†µμ‹ μ© ν¬νΈ
    restart: unless-stopped # μ»¨ν…μ΄λ„κ°€ μ¤‘μ§€λλ©΄ μλ™μΌλ΅ μ¬μ‹μ‘
    networks:
      - patroni-net # Docker λ„¤νΈμ›ν¬μ— μ—°κ²°

# π“ db1μ€ Patroniκ°€ λ¶™μ€ PostgreSQL Primary ν›„λ³΄ λ…Έλ“μ…λ‹λ‹¤.
  db1:
    image: registry.opensource.zalan.do/acid/patroni:2.1-p1
    container_name: db1
    volumes:
      - /mnt/shared/db1:/home/postgres/pgdata # λ°μ΄ν„° λ””λ ‰ν† λ¦¬
      - ./patroni/db1.yml:/config/patroni.yml # Patroni μ„¤μ • νμΌ
    environment:
      - PATRONI_CONFIG_FILE=/config/patroni.yml #Patroni μ„¤μ • κ²½λ΅ μ§€μ •
    ports:
      - "5432:5432" # PostgreSQL ν¬νΈ
    depends_on:
      - etcd # etcd μ„λΉ„μ¤μ— μμ΅΄
    networks:
      - patroni-net # Docker λ„¤νΈμ›ν¬μ— μ—°κ²°

# π“ db2λ” Patroniκ°€ λ¶™μ€ PostgreSQL Replicaμ…λ‹λ‹¤.
  db2:
    image: registry.opensource.zalan.do/acid/patroni:2.1-p1
    container_name: db2
    volumes:
      - /mnt/shared/db2:/home/postgres/pgdata                  # db2μ λ³„λ„ λ°μ΄ν„° λ³Όλ¥¨
      - ./patroni/db2.yml:/config/patroni.yml
    environment:
      - PATRONI_CONFIG_FILE=/config/patroni.yml
    ports:
      - "5433:5432"                                             # λ‹¤λ¥Έ ν¬νΈλ΅ μ—΄μ–΄ μ¶©λ λ°©μ§€
    depends_on:
      - etcd
    networks:
      - patroni-net

 # π§­ HAProxyλ” ν΄λΌμ΄μ–ΈνΈ μ”μ²­μ„ ν„μ¬ Primary PostgreSQL λ…Έλ“λ΅ μλ™ λΌμ°ν…ν•©λ‹λ‹¤.
  haproxy:
    image: haproxy:2.4
    container_name: haproxy
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "5000:5000"      # ν΄λΌμ΄μ–ΈνΈλ” ν•­μƒ μ΄ ν¬νΈλ΅ μ ‘μ†
    depends_on:
      - db1
      - db2
    networks:
      - patroni-net

networks:
  patroni-net:
    driver: bridge # Docker λΈλ¦¬μ§€ λ„¤νΈμ›ν¬ μ‚¬μ©